<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Conta Carboidrati</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
  <style>
    body {font-family: system-ui, sans-serif; margin: 0; padding: 20px; background-color: #f8f8f8; color: #333;}
    h2 {text-align: center; margin-bottom: 10px;}
    .version {text-align: center; font-size: 0.9em; color: #888; margin-bottom: 20px;}
    .container {max-width: 500px; margin: auto; background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);} 
    .tab-buttons {display: flex; justify-content: space-between; margin-bottom: 20px;} 
    .tab-button {flex: 1; text-align: center; padding: 12px; background-color: #e0e0e0; border: 1px solid #ccc; cursor: pointer; border-radius: 8px; margin-right: 6px; font-weight: bold;} 
    .tab-button:last-child {margin-right: 0;} 
    .tab-button.active {background-color: #007bff; color: white; border-color: #007bff;} 
    label {font-weight: 600; margin-top: 12px; display: block;} 
    input {width: 100%; padding: 10px; font-size: 1em; margin-top: 6px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box;} 
    .suggestions {border: 1px solid #ccc; border-top: none; max-height: 150px; overflow-y: auto; background: white; position: absolute; width: 100%; z-index: 999;} 
    .suggestion {padding: 10px; cursor: pointer;} 
    .suggestion:hover {background-color: #f0f0f0;} 
    button {margin-top: 20px; width: 100%; padding: 12px; font-size: 1.1em; background-color: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer;} 
    button:hover {background-color: #0056b3;} 
    .result {margin-top: 24px; text-align: center; font-size: 1.6em; font-weight: bold; color: #28a745;} 
    .form-section {display: none; position: relative;} 
  </style>
</head>
<body>
  <div class="container">
    <h2>Conta Carboidrati</h2>
    <div class="version">v1.12 - 2025-08-10</div>

    <div class="tab-buttons">
      <div id="tabPeso" class="tab-button active" onclick="selectTab('peso')">Peso</div>
      <div id="tabQuantita" class="tab-button" onclick="selectTab('quantita')">Quantità</div>
    </div>

    <div id="formPeso" class="form-section" style="display: block;">
      <label for="alimentoInput">Scegli un alimento:</label>
      <input id="alimentoInput" autocomplete="off" placeholder="Digita per cercare...">
      <div id="suggerimentiPeso" class="suggestions"></div>

      <label for="peso">Inserisci il peso (in grammi):</label>
      <input type="number" id="peso" placeholder="Es. 120">
    </div>

    <div id="formQuantita" class="form-section">
      <label for="quantitaInput">Scegli un alimento:</label>
      <input id="quantitaInput" autocomplete="off" placeholder="Digita per cercare...">
      <div id="suggerimentiQuantita" class="suggestions"></div>

      <label for="numeroPorzioni">Numero di unità:</label>
      <input type="number" id="numeroPorzioni" placeholder="Es. 3">
    </div>

    <button onclick="calcola()">Calcola Carboidrati</button>
    <div class="result" id="output"></div>
  </div>

  <script>
    let alimenti = [], quantita = [];
    let fuseAlimenti, fuseQuantita;

    fetch('alimenti.json').then(r => r.json()).then(data => {
      alimenti = data;
      fuseAlimenti = new Fuse(data, { keys: ['nome'], threshold: 0.3 });
    });

    fetch('quantita.json').then(r => r.json()).then(data => {
      quantita = data;
      fuseQuantita = new Fuse(data, { keys: ['nome'], threshold: 0.3 });
    });

    function selectTab(tipo) {
      document.getElementById("tabPeso").classList.remove("active");
      document.getElementById("tabQuantita").classList.remove("active");

      if (tipo === "peso") {
        document.getElementById("tabPeso").classList.add("active");
        document.getElementById("formPeso").style.display = "block";
        document.getElementById("formQuantita").style.display = "none";
      } else {
        document.getElementById("tabQuantita").classList.add("active");
        document.getElementById("formPeso").style.display = "none";
        document.getElementById("formQuantita").style.display = "block";
      }

      document.getElementById("alimentoInput").value = "";
      document.getElementById("peso").value = "";
      document.getElementById("quantitaInput").value = "";
      document.getElementById("numeroPorzioni").value = "";
      document.getElementById("output").innerText = "";
      clearSuggestions("suggerimentiPeso");
      clearSuggestions("suggerimentiQuantita");
    }

    function showSuggestions(fuse, query, containerId, inputId, isPeso) {
      const results = fuse.search(query).slice(0, 5);
      const container = document.getElementById(containerId);
      clearSuggestions(containerId);
      results.forEach(r => {
        const div = document.createElement("div");
        div.className = "suggestion";
        div.textContent = r.item.nome;
        div.onclick = () => {
          document.getElementById(inputId).value = r.item.nome;
          clearSuggestions(containerId);
          if (isPeso) {
            document.getElementById("peso").value = 100;
          } else {
            document.getElementById("numeroPorzioni").value = 1;
          }
          calcola();
        };
        container.appendChild(div);
      });
    }

    function clearSuggestions(id) { document.getElementById(id).innerHTML = ""; }

    function calcola() {
      const isPeso = document.getElementById("formPeso").style.display === "block";
      const nome = isPeso ? document.getElementById("alimentoInput").value : document.getElementById("quantitaInput").value;
      const inputVal = isPeso ? parseFloat(document.getElementById("peso").value) : parseFloat(document.getElementById("numeroPorzioni").value);
      const dataset = isPeso ? fuseAlimenti.search(nome) : fuseQuantita.search(nome);
      const alimento = dataset.length > 0 ? dataset[0].item : null;

      if (alimento && !isNaN(inputVal)) {
        const carbo = isPeso ? Math.round(alimento.carbo * inputVal / 100) : Math.round(alimento.carbo * inputVal);
        document.getElementById("output").innerHTML = "Carboidrati totali:<br><span style='font-size: 2em; color: #dc3545'>" + carbo + " g</span>";
      } else {
        document.getElementById("output").innerText = "Inserisci valori validi.";
      }
    }

    document.getElementById("alimentoInput").addEventListener("input", e => {
      showSuggestions(fuseAlimenti, e.target.value, "suggerimentiPeso", "alimentoInput", true);
    });
    document.getElementById("quantitaInput").addEventListener("input", e => {
      showSuggestions(fuseQuantita, e.target.value, "suggerimentiQuantita", "quantitaInput", false);
    });

    document.getElementById("peso").addEventListener("focus", () => { document.getElementById("peso").value = ""; });
    document.getElementById("numeroPorzioni").addEventListener("focus", () => { document.getElementById("numeroPorzioni").value = ""; });

    // Invio con Enter
    document.querySelectorAll('#peso, #numeroPorzioni, #alimentoInput, #quantitaInput').forEach(el => {
      el.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          calcola();
        }
      });
    });
  </script>
</body>
</html>
